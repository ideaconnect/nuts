# Example Caddyfile for the nuts module
#
# This configuration sets up a Caddy server with the nuts module
# that bridges NATS.io JetStream messages to Server-Sent Events.
#
# Prerequisites:
#   1. Start NATS with JetStream enabled:
#      docker run -p 4222:4222 nats:latest -js
#
#   2. Create the JetStream stream:
#      nats stream add EVENTS --subjects "events.>" --storage file --max-msgs 10000 --max-age 24h --discard old
#
#   3. Run Caddy with this config

{
	# Global options
	admin off
	
	# Order the nuts directive in the handler chain
	order nuts before respond
}

# Main site configuration
:8080 {
	# SSE endpoint for NATS messages
	# Clients can connect to:
	#   - /events?topic=my-topic
	#   - /events?topic=topic1&topic=topic2  (multiple topics)
	#   - /events/my-topic  (path-based topic)
	#   - /events?topic=my-topic&last-id=123  (replay from sequence 123)
	route /events* {
		nuts {
			# NATS server URL (default: nats://localhost:4222)
			nats_url nats://localhost:4222
			
			# JetStream stream name (required)
			# The stream must be created before starting Caddy
			stream_name EVENTS
			
			# Prefix for all topic subscriptions
			# Must match the stream subjects pattern (e.g., stream subjects "events.>")
			topic_prefix events.
			
			# Optional: NATS credentials file for authentication
			# nats_credentials /path/to/creds.creds
			
			# Optional: NATS token authentication
			# nats_token mytoken
			
			# Optional: NATS user/password authentication
			# nats_user myuser
			# nats_password mypassword
			
			# CORS allowed origins (default: *)
			allowed_origins * 
			
			# Heartbeat interval in seconds (default: 30)
			heartbeat_interval 30
			
			# NATS reconnect wait time in seconds (default: 2)
			reconnect_wait 2
			
			# Maximum reconnection attempts (-1 for infinite, default: -1)
			max_reconnects -1
		}
	}
	
	# Serve static files (optional - for testing)
	root * /var/www/html
	file_server
	
	# Health check endpoint
	respond /health 200 {
		body "OK"
	}
}
